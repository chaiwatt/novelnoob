<?php

namespace Database\Seeders;

use App\Models\Post;
use App\Models\User;
use App\Models\Comment;
use Illuminate\Database\Seeder;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;

class CommunitySeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô UserSeeder (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
        $users = User::all();
        $userIDs = $users->pluck('id');
        $authors = $users->filter(fn($user) => $user->type === 'writer' || $user->type === 'admin');

        // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mock Contents ‡∏à‡∏≤‡∏Å JavaScript
        $mockContents = [
            "‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÉ‡∏ä‡πâ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡πÑ‡∏õ‡∏Ñ‡πà‡∏∞ ‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÉ‡∏à‡∏°‡∏≤‡∏Å ‡πÅ‡∏Ñ‡πà‡πÉ‡∏™‡πà‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÑ‡∏õ‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏û‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡∏¢",
            "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÅ‡∏ô‡∏ß‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏µ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏•‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏á‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏Å‡∏±‡∏ô‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏≤‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢",
            "Writer's block ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏°‡∏≤‡∏ô‡∏°‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡∏û‡∏≠‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞",
            "‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ô‡πà‡∏≤‡∏ó‡∏∂‡πà‡∏á‡∏°‡∏≤‡∏Å ‡πÑ‡∏î‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏∏‡∏î‡πÜ",
            "‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Novel Noob ‡∏î‡∏µ‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á‡πÜ",
            "‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô: ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏ó‡πà‡∏≤‡∏ô ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö",
            "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÅ‡∏ô‡∏ß‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô ‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?",
            "‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Ebook ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞"
        ];
        
        // 3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mock Comments (‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå)
        $mockCommentContents = [
            "‡∏•‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢!",
            "‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏ö‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß",
            "‡∏Ç‡∏≠‡∏á‡∏ú‡∏°‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞",
            "‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡πà‡∏∞ ‡∏û‡∏≠‡∏°‡∏µ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡∏∏‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞",
            "‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ö‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß"
        ];

        $emojis = ['üëç', '‚ù§Ô∏è', 'üòÆ', 'üòÇ', 'üò¢', 'üò†'];

        // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå 30 ‡πÇ‡∏û‡∏™‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
        for ($i = 0; $i < 30; $i++) {
            // ‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
            $author = $authors->random();

            $post = Post::create([
                'user_id' => $author->id,
                'content' => $mockContents[$i % count($mockContents)] ,
                'created_at' => now()->subMinutes(rand(1, 1440)), // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
                'updated_at' => now(),
            ]);

            // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á Comments
            $commentCount = rand(0, 3);
            for ($c = 0; $c < $commentCount; $c++) {
                // ‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å User ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                $commentAuthor = $users->random(); 
                Comment::create([
                    'post_id' => $post->id,
                    'user_id' => $commentAuthor->id,
                    'content' => $mockCommentContents[$c % count($mockCommentContents)],
                    'created_at' => $post->created_at->addMinutes(rand(1, 60)),
                ]);
            }

            // 6. ‡∏™‡∏£‡πâ‡∏≤‡∏á Reactions (Likes)
            $likeCount = rand(5, 50);
            $likers = $userIDs->shuffle()->take($likeCount); 

            // FIX: ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ detach/attach ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pivot ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ ID
            // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Reaction ‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå reaction_type ‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            $post->reactions()->detach(); 

            foreach ($likers as $likerId) {
                $reactionType = $emojis[array_rand($emojis)];

                // FIX: ‡πÉ‡∏ä‡πâ attach() ‡πÅ‡∏ó‡∏ô syncWithoutDetaching() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Composite Key Pivot
                // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                if (!$post->reactions()->wherePivot('user_id', $likerId)->exists()) {
                     $post->reactions()->attach($likerId, [
                        'reaction_type' => $reactionType
                    ]);
                }
            }
            
            // 7. ‡∏™‡∏£‡πâ‡∏≤‡∏á Useful Marks
            $usefulCount = rand(0, 10);
            $usefulUsers = $userIDs->shuffle()->take($usefulCount); 
            
            // FIX: ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ detach/attach ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pivot ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ ID
            $post->usefuls()->detach();
            $post->usefuls()->attach($usefulUsers); // FIX: ‡πÉ‡∏ä‡πâ attach()
        }
    }
}